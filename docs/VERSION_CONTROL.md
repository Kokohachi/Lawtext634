# 規約類バージョン管理・差分表示機能

## 概要

このドキュメントでは、Lawtext634に実装された規約類の改正履歴追跡と差分表示機能について説明します。

## 主な機能

### 1. バージョン履歴管理

- 規約類の複数バージョンを管理
- 各バージョンの制定日、状態（現行/改正済/廃止）を記録
- 改正内容（全部改正/一部改正）の記録
- 改正を行った規約類へのリンク

### 2. バージョン比較（Diff表示）

- 2つのバージョンを選択して比較
- GitHubスタイルの差分ハイライト表示
- 分割表示（Split View）と統合表示（Unified View）の切り替え
- 行単位での追加・削除・変更の可視化

### 3. タブ切り替えインターフェース

- **現行版タブ**: 現在表示中のバージョンを選択
- **改正履歴タブ**: すべてのバージョンを時系列で表示
- **比較タブ**: 2つのバージョンを比較して差分を表示

## データ構造

### versions.json

規約類のバージョン情報は `sample_regulations/versions.json` に保存されます。

```json
{
  "校友会規約": {
    "baseName": "校友会規約",
    "versions": [
      {
        "id": "reiwa6",
        "year": "令和六年",
        "number": "規約",
        "title": "校友会規約（令和六年規約）",
        "filename": "校友会規約（令和六年規約）.law.txt",
        "date": "2024-04-01",
        "status": "superseded",
        "amendedBy": ["校友会規約（令和七年規約）"],
        "amendments": []
      },
      {
        "id": "reiwa7",
        "year": "令和七年",
        "number": "規約",
        "title": "校友会規約（令和七年規約）",
        "filename": "校友会規約（令和七年規約）.law.txt",
        "date": "2025-04-01",
        "status": "current",
        "amendedBy": [],
        "amendments": [
          {
            "type": "全部改正",
            "description": "全部改正",
            "previousVersion": "reiwa6"
          }
        ]
      }
    ]
  }
}
```

### バージョンステータス

- `current`: 現行版
- `superseded`: 改正済み（新しいバージョンが存在）
- `abolished`: 廃止

### 改正タイプ

- `全部改正`: 規約全体を改正
- `一部改正`: 規約の一部を改正

## 使用方法

### 1. 規約を開く

サイドバーから規約を選択、または検索して規約を開きます。

### 2. バージョン履歴を確認

規約に複数のバージョンがある場合、規約本文の上に「バージョン管理パネル」が表示されます。

「改正履歴」タブをクリックすると、すべてのバージョンが時系列で表示されます。各バージョンには以下の情報が含まれます：

- バージョンタイトル
- 制定日
- 状態（現行/改正済/廃止）
- 改正内容
- 改正元の規約

### 3. バージョンを比較

#### 方法1: 改正履歴タブから

1. 「改正履歴」タブでバージョンを1つ選択
2. 「他のバージョンと比較」ボタンをクリック
3. 比較したい別のバージョンをクリック
4. 自動的に「比較」タブに切り替わり、差分が表示されます

#### 方法2: 比較タブから

1. 「比較」タブをクリック
2. 「旧版を選択」ドロップダウンから古いバージョンを選択
3. 「新版を選択」ドロップダウンから新しいバージョンを選択
4. 「比較を表示」ボタンをクリック

### 4. 差分表示の操作

- **分割表示**: 旧版と新版を左右に並べて表示
- **統合表示**: 変更を1つの画面にまとめて表示
- 追加された行は緑色、削除された行は赤色で表示
- 行番号をクリックして特定の箇所にジャンプ可能

## 新しいバージョンの追加方法

### 1. 新しい規約ファイルを作成

`sample_regulations/` ディレクトリに新しい `.law.txt` ファイルを作成します。

例: `校友会規約（令和八年規約）.law.txt`

### 2. versions.json を更新

該当する規約のバージョン情報を追加します：

```json
{
  "校友会規約": {
    "baseName": "校友会規約",
    "versions": [
      // 既存のバージョン...
      {
        "id": "reiwa8",
        "year": "令和八年",
        "number": "規約",
        "title": "校友会規約（令和八年規約）",
        "filename": "校友会規約（令和八年規約）.law.txt",
        "date": "2026-04-01",
        "status": "current",
        "amendedBy": [],
        "amendments": [
          {
            "type": "一部改正",
            "description": "第三条の理念規定を改正",
            "previousVersion": "reiwa7"
          }
        ]
      }
    ]
  }
}
```

### 3. 旧バージョンのステータスを更新

前のバージョンのステータスを `current` から `superseded` に変更し、`amendedBy` フィールドを更新します：

```json
{
  "id": "reiwa7",
  "status": "superseded",
  "amendedBy": ["校友会規約（令和八年規約）"],
  // ...
}
```

### 4. ビルドとデプロイ

```bash
cd app
npm run build
```

ビルド時に自動的に新しいファイルと `versions.json` が `dist-prod/data/` にコピーされます。

## 技術詳細

### コンポーネント構成

- **VersionControlPanel**: タブ切り替えとバージョン選択を管理
- **VersionHistoryViewer**: バージョン履歴のリスト表示
- **DiffViewer**: 2つのバージョンの差分表示

### 差分アルゴリズム

差分表示には `diff` ライブラリを使用しており、GitHubと同様の差分アルゴリズムで行単位の比較を行います。

### データローディング

- `versions.json` は初回アクセス時にキャッシュされます
- 各バージョンのテキストは比較時に動的にロードされます

## GitHubとの互換性

この機能は、GitHubのコミット差分表示と同様のユーザーエクスペリエンスを提供します。条文番号の繰り下げや挿入があっても、GitHubと同じ差分アルゴリズムにより、変更箇所を正確に識別できます。

参考: [GitHubでの法令管理例](https://github.com/yamachig/Lawtext-sample-Administrative-Procedure-Act/commit/8832079d99549b1c605e92bfd3774e79b10e58ed?diff=split)

## 今後の拡張予定

- [ ] バージョン間のナビゲーション（前のバージョン/次のバージョンボタン）
- [ ] 特定の条文の変更履歴表示
- [ ] 改正理由や審議記録へのリンク
- [ ] エクスポート機能（差分をPDFやWordで出力）
